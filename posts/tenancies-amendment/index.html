<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="prefer-datetime-locale" content="en-nz"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="NZ Housing Policy Exploration" /><meta property="og:locale" content="en" /><meta name="description" content="In this post, I illustrate an end-to-end data science project investigating the impact of the February 2021 Residential Tenancies Amendment Bill by observing changing rental trends on the New Zealand housing market." /><meta property="og:description" content="In this post, I illustrate an end-to-end data science project investigating the impact of the February 2021 Residential Tenancies Amendment Bill by observing changing rental trends on the New Zealand housing market." /><link rel="canonical" href="https://chaserobertson.github.io/posts/tenancies-amendment/" /><meta property="og:url" content="https://chaserobertson.github.io/posts/tenancies-amendment/" /><meta property="og:site_name" content="Chase Robertson" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-16T00:00:00+12:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="NZ Housing Policy Exploration" /><meta name="twitter:site" content="@chase__rob" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-16T00:00:00+12:00","datePublished":"2022-05-16T00:00:00+12:00","description":"In this post, I illustrate an end-to-end data science project investigating the impact of the February 2021 Residential Tenancies Amendment Bill by observing changing rental trends on the New Zealand housing market.","headline":"NZ Housing Policy Exploration","mainEntityOfPage":{"@type":"WebPage","@id":"https://chaserobertson.github.io/posts/tenancies-amendment/"},"url":"https://chaserobertson.github.io/posts/tenancies-amendment/"}</script><title>NZ Housing Policy Exploration | Chase Robertson</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Chase Robertson"><meta name="application-name" content="Chase Robertson"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="stylesheet" href="/assets/lib/bootstrap-4.6.1/bootstrap.min.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free-5.15.4/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/lib/magnific-popup-1.1.0/magnific-popup.css"> <script src="/assets/lib/jquery-3.6.0/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/me.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Chase Robertson</a></div><div class="site-subtitle font-italic">Data Scientist</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/Thesis/" class="nav-link"> <i class="fa-fw fas fa-bolt ml-xl-3 mr-xl-3 unloaded"></i> <span>THESIS</span> </a><li class="nav-item"> <a href="/Resume/" class="nav-link"> <i class="fa-fw fas fa-user ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a><li class="nav-item"> <a href="/CV/" class="nav-link"> <i class="fa-fw fas fa-address-card ml-xl-3 mr-xl-3 unloaded"></i> <span>CV</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/certifications/" class="nav-link"> <i class="fa-fw fas fa-certificate ml-xl-3 mr-xl-3 unloaded"></i> <span>CERTIFICATIONS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/chaserobertson" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/chase__rob" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['chaserobertson208','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://linkedin.com/in/chase-robertson" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>NZ Housing Policy Exploration</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><h1 data-toc-skip>NZ Housing Policy Exploration</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1652616000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> 16 May 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/chase__rob">Chase Robertson</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2925 words"> <em>16 min</em> read</span></div></div></div><div class="post-content"><p>In this post, I illustrate an end-to-end data science project investigating the impact of the February 2021 Residential Tenancies Amendment Bill by observing changing rental trends on the New Zealand housing market.</p><h1 id="data-source">Data Source</h1><p>The data is sourced from the NZ Tenancy Services <a href="https://www.tenancy.govt.nz/about-tenancy-services/data-and-statistics/rental-bond-data">website</a>. Three CSV files are provided with territorial, regional, and quarterly aggregate bond statistics. In order to translate Location Id’s from the quarterly dataset into location names, it is also necessary to retrieve data from the Stats NZ <a href="https://datafinder.stats.govt.nz/layer/98770-statistical-area-2-2019-centroid-true/">site</a>.</p><h1 id="data-processing">Data Processing</h1><p>One of the first data processing tasks is to ensure each data column is imported as the correct type, to ensure proper usage later in the analysis.</p><p>Some of the “.Bond” and “.Rent” columns of each dataset import as character-type columns, which does not match their numeric contents. I found that removing the thousands-delimiting commas made converting to integer type possible.</p><div class="language-r highlighter-rouge"><div class="code-header"> <span data-label-text="R"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1"># remove comma from numeric values and convert columns</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">q2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">quarterly</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">replace_na</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">Location.Id</span><span class="o">=</span><span class="m">-1</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="n">str_subset</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">quarterly</span><span class="p">),</span><span class="w"> 
                             </span><span class="n">regex</span><span class="p">(</span><span class="s2">".Bond|(n|e).Rent|.Id"</span><span class="p">)),</span><span class="w">
                  </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">gsub</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))}))</span><span class="w">
</span></pre></table></code></div></div><p>The next data processing step is to convert the <code class="language-plaintext highlighter-rouge">Time Frame</code> column into more useful <code class="language-plaintext highlighter-rouge">year</code> and <code class="language-plaintext highlighter-rouge">quarter</code> columns. The <code class="language-plaintext highlighter-rouge">lubridate</code> library makes that a simple task.</p><p>I also joined the Stats NZ location ID and location name columns with the quarterly report, so that location names could be easily included in future analysis. It was necessary to manually add ID <code class="language-plaintext highlighter-rouge">-99</code> to get the location name <code class="language-plaintext highlighter-rouge">"ALL"</code> to join correctly.</p><div class="language-r highlighter-rouge"><div class="code-header"> <span data-label-text="R"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">fname</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"statistical-area-2-2019-centroid-true"</span><span class="w">
</span><span class="n">fpath</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"../data/statsnz"</span><span class="p">,</span><span class="w"> </span><span class="n">fname</span><span class="p">,</span><span class="w"> </span><span class="s2">"-CSV/"</span><span class="p">,</span><span class="w"> </span><span class="n">fname</span><span class="p">,</span><span class="w"> </span><span class="s2">".csv"</span><span class="p">)</span><span class="w">

</span><span class="c1"># import and join location names</span><span class="w">
</span><span class="n">areas</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span><span class="w">
</span><span class="n">locations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">areas</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SA22019_V1_00</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SA22019_V1_00_NAME</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">Location</span><span class="p">)</span><span class="w">
</span><span class="n">all_locations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="m">-99</span><span class="p">,</span><span class="w"> </span><span class="s1">'ALL'</span><span class="p">))</span><span class="w">
</span><span class="n">q.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">left_join</span><span class="p">(</span><span class="n">q3</span><span class="p">,</span><span class="w"> </span><span class="n">all_locations</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'Location.Id'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'ID'</span><span class="p">))</span><span class="w">
</span></pre></table></code></div></div><p>A similar set of steps were followed to import the regional and territorial datasets as well, which can be seen in the Appendix.</p><h1 id="data-exploration">Data Exploration</h1><p>The first area of the data explored is the active bond numbers before and after the two-phase Bill implementation in August 2020 and February 2021, searching for any patterns that may change around those dates.</p><p><img data-src="../../assets/img/tenancies/unnamed-chunk-8-1.png" alt="" data-proofer-ignore></p><p>There does seem to be some unexpected change through 2021, which suggests some effect, or perhaps some external factor. Let’s check the number of Total and Closed Bonds as well.</p><p><img data-src="../../assets/img/tenancies/unnamed-chunk-9-1.png" alt="" data-proofer-ignore></p><p>It seems that both Closed and Lodged Bonds follow a similar annual pattern, though with some difference toward the beginning and end of the year. The obvious indicators here are the severe dips in April of 2020 and Aug/Sep of 2021, probably related to the level 4 COVID lockdowns which occurred around those times. It is interesting to note the first few months of 2022: both Closed and Lodged bond numbers are down relative to previous years. This could indicate that there is less moving between residences by renters, as opposed to less residences on the market.</p><p>Let’s check the disaggregated quarterly dataset to see if any bond patterns differ across dwelling types.</p><p><img data-src="../../assets/img/tenancies/unnamed-chunk-10-1.png" alt="" data-proofer-ignore></p><p>Again, it seems that COVID lockdowns in Q2 2020 and Q3 2021 caused a significant perturbation to bond filings across the board, making any effects from the Bill very difficult to distinguish.</p><p>Let’s move to the regional dataset to search for patterns on the regional dimension.</p><p><img data-src="../../assets/img/tenancies/unnamed-chunk-11-1.png" alt="" data-proofer-ignore></p><p>Auckland, Canterbury, Waikato, Wellington, and a few others demonstrate a strong upward trend before the Bill, with a downward trend afterward. Those regions also harbor the largest cities in New Zealand, which begs the question: is this a pattern mostly correlated with urban environments? Could the trend change be an “urban flight” phenomenon caused by COVID-19, rather than changes to rental conditions caused by the Bill?</p><p>There may be too many territories to manage in one plot, but it’s worth a try to see if any patterns can be gleaned at the territorial level. In the plot below, I’ve separated the data before and after Phase 1 of the Bill, and smoothed each side with loess regression, to try to focus the illustration on pattern change.</p><p><img data-src="../../assets/img/tenancies/unnamed-chunk-12-1.png" alt="" data-proofer-ignore></p><h1 id="analytical-plan">Analytical Plan</h1><p>Based on the information illuminated in the data exploration, it seems that the effects of the Bill have varied to some small degree across dwelling types and to a great degree across locations. The analytical path forward is not obvious, to me anyway, because of the huge confounding factors and inherent inability of establishing causality in observational data. I decided to fit a series of models to the data before the Bill’s implementation, and compare the predictions with actual data from the time after the Bill. Random Forest makes for a great baseline, so that is attempted first. Naive and Holt-Winters seasonal predictions are also attempted. Perhaps the most informative, due to the ease of extracting a confidence interval of prediction, is a Bayesian structural time-series model. Two more ad-hoc methods of analysis are attempted as well: spline regression of month-over-month changes in data, to address autocorrelation between data points, and changepoint detection. Hopefully, with information gathered from a few different models, the effects of the Bill become more clear.</p><h1 id="results">Results</h1><p>Below, a Random Forest model trained on all regional monthly data before 2021 (date, year, month and Location variables), predicts the number of Active Bonds in each region.</p><p><img data-src="../../assets/img/tenancies/unnamed-chunk-13-1.png" alt="" data-proofer-ignore></p><p>Prediction is generally not too far from the truth, though it varies greatly by location, and does not capture obvious trajectories, as best illustrated by Tasman and Waikato. Because it is the same model for all locations, it is not able to distinguish the varying seasonality of each location individually. Dunedin’s extreme seasonality may be causing some phantom seasonality in other locations. Overall RF at least gives a fair baseline to compare further predictive models.</p><p>To prevent further crossover noise between locations, <strong>all further modelling and analysis is conducted on Auckland alone.</strong> Auckland is the most populated region in New Zealand, so seems the natural choice.</p><p>The next models that may give some insight to the effects of the 2021 Bill are a naive seasonal model and, likely more effective, Double-Seasonal Holt-Winters forecasting. These models are trained on data between the years 2000 and 2020 (or 2021 in the case of <code class="language-plaintext highlighter-rouge">DSHW_2</code>), and their predictions plotted alongside the actual Closed Bonds data since 2017 below.</p><p><img data-src="../../assets/img/tenancies/unnamed-chunk-14-1.png" alt="" data-proofer-ignore></p><p>The more sophisticated models are actually less accurate than the naive model! This is because they are able to pick up the existing seasonal trends, illustrating the trend change very well. The split between the DSHW models and actual data tracks well with the Bill’s second phase in February of 2021, with the late 2020 downturn almost perfectly accounted for by seasonality.</p><p>Perhaps a more informative model is attempted on the same data below: a Bayesian Structural Time Series Model.</p><p><img data-src="../../assets/img/tenancies/unnamed-chunk-15-1.png" alt="" data-proofer-ignore></p><p>The Bayesian model tracks the upward trend of previous years, but actually underestimates the Phase 1 period. The model is even bucked off from the actual data before the prediction period, by the massive shock of COVID-19 in early 2020.</p><p>The best feature of the Bayesian model is that it also shows a 90% confidence interval. As illustrated by the gray band in the above graph, the actual number of Active Bonds in Auckland has never strayed outside what could reasonably be attributed to random changes in the market. While this doesn’t confirm that the Bill had <strong>no</strong> effect on the rental market, it does confirm that it did not cause a significant effect.</p><p>An unaddressed issue with the modelling thus far is autocorrelation: each time-series data point is correlated with the one previous to it. Below, I attempt to address this autocorrelation. A logarithmic scale is applied to month-over-month changes to the number of Active Bonds, and the log results are transformed back into positive and negative numbers. By applying a linear regression to these transformed values, the same underlying Active Bonds patterns can be seen in a new light.</p><p><img data-src="../../assets/img/tenancies/unnamed-chunk-16-1.png" alt="" data-proofer-ignore></p><p>Since the Bill’s implementation, and especially in recent months, there is a negative trend in how many bonds are active in Auckland.</p><p>Another model I thought might provide some insight to this data is changepoint detection. The below plot shows the Auckland Active Bonds data overlayed with the dates selected by several iterations of the changepoint model, each iteration with a different number of points to identify. Comparing the Bill’s implementation dates with the clusters of changepoints detected, there is again some suggestion that the Bill (or its contemporary pandemic issues) have impacted the rental market in some way.</p><p><img data-src="../../assets/img/tenancies/unnamed-chunk-17-1.png" alt="" data-proofer-ignore></p><h1 id="discussion">Discussion</h1><p>It is fantastic that NZ Tenancy Services provides this rental data to the public. It is clean and thorough, and provides universal ground truth for discussions about policy effectiveness. With finding patterns in this data being the goal of this project, it has actually been quite satisfying to iterate on different models and methods of analysis and ultimately discover the patterns presented here. In this case, however, the data is insufficient to prove any claims about the Tenancy Bill, because of the incredibly confounding factor of COVID-19, among other things. Causality simply cannot be proven to any degree in an observational analysis such as this.</p><h1 id="appendix">Appendix</h1><p>Appendix includes all code necessary to replicate the report.</p><div class="language-r highlighter-rouge"><div class="code-header"> <span data-label-text="R"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
</pre><td class="rouge-code"><pre><span class="c1"># import quarterly dataset, show names and tabulate types</span><span class="w">
</span><span class="n">quarterly</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"../data/Detailed Quarterly Tenancy1.csv"</span><span class="p">)</span><span class="w">
</span><span class="c1">#names(quarterly)</span><span class="w">
</span><span class="c1">#table(sapply(quarterly, class))</span><span class="w">

</span><span class="c1"># remove comma from numeric values and convert columns</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">q2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">quarterly</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">replace_na</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">Location.Id</span><span class="o">=</span><span class="m">-1</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="n">str_subset</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">quarterly</span><span class="p">),</span><span class="w"> 
                             </span><span class="n">regex</span><span class="p">(</span><span class="s2">".Bond|(n|e).Rent|.Id"</span><span class="p">)),</span><span class="w">
                  </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">gsub</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))}))</span><span class="w">

</span><span class="c1"># create year and month columns from Time.Frame</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span><span class="w">
</span><span class="n">q3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">q2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mdy_hm</span><span class="p">(</span><span class="n">Time.Frame</span><span class="p">),</span><span class="w"> </span><span class="n">.before</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">(</span><span class="n">date</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">quarter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">quarter</span><span class="p">(</span><span class="n">date</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">date2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">quarter</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s1">'-'</span><span class="p">))</span><span class="w">
</span><span class="n">fname</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"statistical-area-2-2019-centroid-true"</span><span class="w">
</span><span class="n">fpath</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"../data/statsnz"</span><span class="p">,</span><span class="w"> </span><span class="n">fname</span><span class="p">,</span><span class="w"> </span><span class="s2">"-CSV/"</span><span class="p">,</span><span class="w"> </span><span class="n">fname</span><span class="p">,</span><span class="w"> </span><span class="s2">".csv"</span><span class="p">)</span><span class="w">

</span><span class="c1"># import and join location names</span><span class="w">
</span><span class="n">areas</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span><span class="w">
</span><span class="n">locations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">areas</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SA22019_V1_00</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SA22019_V1_00_NAME</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">Location</span><span class="p">)</span><span class="w">
</span><span class="n">all_locations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="m">-99</span><span class="p">,</span><span class="w"> </span><span class="s1">'ALL'</span><span class="p">))</span><span class="w">
</span><span class="n">q.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">left_join</span><span class="p">(</span><span class="n">q3</span><span class="p">,</span><span class="w"> </span><span class="n">all_locations</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'Location.Id'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'ID'</span><span class="p">))</span><span class="w">

</span><span class="c1"># import and clean regional dataset</span><span class="w">
</span><span class="n">regional</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"../data/rentalbond-data-regional1.csv"</span><span class="p">)</span><span class="w">
</span><span class="n">r2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">regional</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">Lodged.Bonds</span><span class="p">,</span><span class="w"> </span><span class="n">Closed.Bonds</span><span class="p">),</span><span class="w">
                  </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">gsub</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))}))</span><span class="w">
</span><span class="n">r3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ymd</span><span class="p">(</span><span class="n">Time.Frame</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">(</span><span class="n">date</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">month</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">month</span><span class="p">(</span><span class="n">date</span><span class="p">))</span><span class="w">
</span><span class="n">r.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r3</span><span class="w">

</span><span class="c1">#import and clean territorial dataset</span><span class="w">
</span><span class="n">tla</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"../data/rentalbond-data-tla1.csv"</span><span class="p">)</span><span class="w">

</span><span class="n">t2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tla</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">Lodged.Bonds</span><span class="p">,</span><span class="w"> </span><span class="n">Active.Bonds</span><span class="p">),</span><span class="w">
                  </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">gsub</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))}))</span><span class="w">
</span><span class="n">t3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dmy</span><span class="p">(</span><span class="n">Time.Frame</span><span class="p">),</span><span class="w"> </span><span class="n">.before</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">(</span><span class="n">date</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">month</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">month</span><span class="p">(</span><span class="n">date</span><span class="p">))</span><span class="w">
</span><span class="n">t.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">t3</span><span class="w">

</span><span class="c1"># prepare for plotting</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">theme_set</span><span class="p">(</span><span class="n">theme_minimal</span><span class="p">())</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">viridis</span><span class="p">)</span><span class="w">
</span><span class="n">colours</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"#440154FF"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#FDE725FF"</span><span class="p">)</span><span class="w">

</span><span class="c1"># aggregate regional Active Bonds</span><span class="w">
</span><span class="n">rplot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location.Id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">-99</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">2016</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">year</span><span class="p">))</span><span class="w">

</span><span class="n">rplot</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">Active.Bonds</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">year</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">filter</span><span class="p">(</span><span class="n">rplot</span><span class="p">,</span><span class="w"> </span><span class="n">date</span><span class="o">==</span><span class="n">as.Date</span><span class="p">(</span><span class="s1">'2021-02-01'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">date</span><span class="o">==</span><span class="n">as.Date</span><span class="p">(</span><span class="s1">'2020-08-01'</span><span class="p">)),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">scale_colour_viridis_d</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">guides</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guide_legend</span><span class="p">(</span><span class="n">reverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">scale_x_discrete</span><span class="p">(</span><span class="s1">'month'</span><span class="p">,</span><span class="w"> </span><span class="n">limits</span><span class="o">=</span><span class="nb">month.abb</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">12</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Active Bonds Annual Patterns"</span><span class="p">)</span><span class="w">

</span><span class="c1"># closed and lodged regional Active Bonds</span><span class="w">
</span><span class="n">rplot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"ALL"</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">2017</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">year</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">pivot_longer</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">Lodged.Bonds</span><span class="p">,</span><span class="w"> </span><span class="n">Closed.Bonds</span><span class="p">),</span><span class="w"> 
                 </span><span class="n">names_to</span><span class="o">=</span><span class="s2">"Bond.Type"</span><span class="p">,</span><span class="w"> </span><span class="n">values_to</span><span class="o">=</span><span class="s2">"N.Bonds"</span><span class="p">)</span><span class="w">

</span><span class="n">rplot</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">N.Bonds</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">year</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_grid</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="n">vars</span><span class="p">(</span><span class="n">Bond.Type</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">filter</span><span class="p">(</span><span class="n">rplot</span><span class="p">,</span><span class="w"> </span><span class="n">date</span><span class="o">==</span><span class="n">as.Date</span><span class="p">(</span><span class="s1">'2021-02-01'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">date</span><span class="o">==</span><span class="n">as.Date</span><span class="p">(</span><span class="s1">'2020-08-01'</span><span class="p">)),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">scale_colour_viridis_d</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">guides</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guide_legend</span><span class="p">(</span><span class="n">reverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">scale_x_discrete</span><span class="p">(</span><span class="s1">'month'</span><span class="p">,</span><span class="w"> </span><span class="n">limits</span><span class="o">=</span><span class="nb">month.abb</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">12</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Closed and Lodged Bonds Annual Patterns"</span><span class="p">)</span><span class="w">

</span><span class="c1"># closed and total quarterly Active Bonds per dwelling type</span><span class="w">
</span><span class="n">qplot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">q.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"ALL"</span><span class="p">,</span><span class="w"> </span><span class="n">Number.Of.Beds</span><span class="o">==</span><span class="s2">"ALL"</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">2017</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">year</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">pivot_longer</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">Total.Bonds</span><span class="p">,</span><span class="w"> </span><span class="n">Closed.Bonds</span><span class="p">),</span><span class="w"> 
                 </span><span class="n">names_to</span><span class="o">=</span><span class="s2">"Bond.Type"</span><span class="p">,</span><span class="w"> </span><span class="n">values_to</span><span class="o">=</span><span class="s2">"N.Bonds"</span><span class="p">)</span><span class="w">

</span><span class="n">qplot</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">quarter</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">N.Bonds</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">year</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_wrap</span><span class="p">(</span><span class="n">Bond.Type</span><span class="o">~</span><span class="n">Dwelling.Type</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="m">6</span><span class="p">,</span><span class="w"> 
               </span><span class="n">scales</span><span class="o">=</span><span class="s2">"free_y"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">scale_colour_viridis_d</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">guides</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guide_legend</span><span class="p">(</span><span class="n">reverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.title.y</span><span class="o">=</span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Closed and Total Bonds Annual Patterns per Dwelling Type"</span><span class="p">)</span><span class="w">
</span><span class="c1"># active bonds by region</span><span class="w">
</span><span class="n">r.loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location.Id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">2016</span><span class="p">)</span><span class="w">

</span><span class="n">r.loc</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">Active.Bonds</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">Location</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="o">=</span><span class="s1">'free_y'</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"2021-02-01"</span><span class="p">,</span><span class="w"> </span><span class="s2">"2020-08-12"</span><span class="p">)),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">theme</span><span class="p">(</span><span class="n">strip.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">),</span><span class="w"> 
          </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottom"</span><span class="p">,</span><span class="w"> </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Active Bonds by Region 2017-2021'</span><span class="p">)</span><span class="w">

</span><span class="c1"># active bonds by territory</span><span class="w">
</span><span class="n">t.loc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location.Id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">2016</span><span class="p">)</span><span class="w">

</span><span class="n">t.loc</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">Active.Bonds</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">Location</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="o">=</span><span class="s1">'free_y'</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="m">6</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">filter</span><span class="p">(</span><span class="n">t.loc</span><span class="p">,</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2020-08-12"</span><span class="p">)),</span><span class="w"> </span><span class="n">span</span><span class="o">=</span><span class="m">0.99</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">filter</span><span class="p">(</span><span class="n">t.loc</span><span class="p">,</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2020-08-01"</span><span class="p">)),</span><span class="w"> </span><span class="n">span</span><span class="o">=</span><span class="m">0.99</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"2021-02-01"</span><span class="p">,</span><span class="w"> </span><span class="s2">"2020-08-12"</span><span class="p">)),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">theme</span><span class="p">(</span><span class="n">strip.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">),</span><span class="w">
          </span><span class="n">axis.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Active Bonds by Territory'</span><span class="p">)</span><span class="w">

</span><span class="c1"># train and plot predictions of Random Forest</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ranger</span><span class="p">)</span><span class="w">

</span><span class="n">fdata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">Location.Id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">Location</span><span class="p">,</span><span class="w"> </span><span class="n">Active.Bonds</span><span class="p">)</span><span class="w">
</span><span class="n">train</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fdata</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">2000</span><span class="p">,</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2020-08-12"</span><span class="p">))</span><span class="w">
</span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fdata</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2020-08-12"</span><span class="p">))</span><span class="w">

</span><span class="n">forest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ranger</span><span class="p">(</span><span class="n">Active.Bonds</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">month</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Location</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">train</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">num.trees</span><span class="o">=</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">mtry</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">forest</span><span class="p">,</span><span class="w"> </span><span class="n">test</span><span class="p">)</span><span class="w">

</span><span class="n">trainplot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="o">&gt;</span><span class="m">2017</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">RF.Prediction</span><span class="o">=</span><span class="kc">NA</span><span class="p">)</span><span class="w">

</span><span class="n">testplot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="n">RF.Prediction</span><span class="o">=</span><span class="n">p</span><span class="o">$</span><span class="n">predictions</span><span class="p">)</span><span class="w"> 

</span><span class="n">fplot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">trainplot</span><span class="p">,</span><span class="w"> </span><span class="n">testplot</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">pivot_longer</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">Active.Bonds</span><span class="p">,</span><span class="w"> </span><span class="n">RF.Prediction</span><span class="p">),</span><span class="w"> </span><span class="n">names_to</span><span class="o">=</span><span class="s1">'source'</span><span class="p">,</span><span class="w"> </span><span class="n">values_to</span><span class="o">=</span><span class="s1">'value'</span><span class="p">)</span><span class="w">

</span><span class="n">fplot</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">source</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">Location</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="o">=</span><span class="s1">'free_y'</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"2021-02-01"</span><span class="p">,</span><span class="s2">"2020-08-12"</span><span class="p">)),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="s1">'dashed'</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_colour_viridis_d</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">strip.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">),</span><span class="w"> </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottom"</span><span class="p">,</span><span class="w"> </span><span class="n">axis.title.y</span><span class="o">=</span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Active Bonds vs Random Forest Prediction 2020-2022'</span><span class="p">)</span><span class="w">

</span><span class="c1"># fit and plot naive and double-seasonal Holt-Winters forecasting</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span><span class="w">
</span><span class="n">year_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2000</span><span class="w">

</span><span class="n">timesdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">Location.Id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">year_start</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">Active.Bonds</span><span class="p">)</span><span class="w">

</span><span class="n">timesr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">(</span><span class="n">timesdf</span><span class="o">$</span><span class="n">Active.Bonds</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="o">=</span><span class="n">year_start</span><span class="p">,</span><span class="w"> </span><span class="n">deltat</span><span class="o">=</span><span class="m">1</span><span class="o">/</span><span class="m">12</span><span class="p">)</span><span class="w">

</span><span class="n">training</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">window</span><span class="p">(</span><span class="n">timesr</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">year_start</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">end</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2020</span><span class="p">,</span><span class="w"> </span><span class="m">7</span><span class="p">))</span><span class="w">
</span><span class="n">validation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">window</span><span class="p">(</span><span class="n">timesr</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2020</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">))</span><span class="w">

</span><span class="n">train_covid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">window</span><span class="p">(</span><span class="n">timesr</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2021</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">
</span><span class="n">valid_covid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">window</span><span class="p">(</span><span class="n">timesr</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2021</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">))</span><span class="w">

</span><span class="n">naive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snaive</span><span class="p">(</span><span class="n">training</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">validation</span><span class="p">),</span><span class="w"> </span><span class="n">lambda</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">)</span><span class="w">
</span><span class="n">dshw</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dshw</span><span class="p">(</span><span class="n">training</span><span class="p">,</span><span class="w"> </span><span class="n">period1</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">period2</span><span class="o">=</span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">validation</span><span class="p">))</span><span class="w">
</span><span class="n">dshw_covid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dshw</span><span class="p">(</span><span class="n">train_covid</span><span class="p">,</span><span class="w"> </span><span class="n">period1</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">period2</span><span class="o">=</span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">valid_covid</span><span class="p">))</span><span class="w">

</span><span class="n">naive.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">zoo</span><span class="o">::</span><span class="n">as.Date</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="n">naive</span><span class="o">$</span><span class="n">mean</span><span class="p">)),</span><span class="w"> </span><span class="n">B_Naive</span><span class="o">=</span><span class="n">naive</span><span class="o">$</span><span class="n">mean</span><span class="p">)</span><span class="w">
</span><span class="n">dshw.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">zoo</span><span class="o">::</span><span class="n">as.Date</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="n">dshw</span><span class="o">$</span><span class="n">mean</span><span class="p">)),</span><span class="w"> </span><span class="n">DSHW_1</span><span class="o">=</span><span class="n">dshw</span><span class="o">$</span><span class="n">mean</span><span class="p">)</span><span class="w">
</span><span class="n">dshw_covid.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">zoo</span><span class="o">::</span><span class="n">as.Date</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="n">dshw_covid</span><span class="o">$</span><span class="n">mean</span><span class="p">)),</span><span class="w"> </span><span class="n">DSHW_2</span><span class="o">=</span><span class="n">dshw_covid</span><span class="o">$</span><span class="n">mean</span><span class="p">)</span><span class="w">

</span><span class="n">timesplot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">Location.Id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">2017</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">naive.df</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="s1">'date'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">dshw.df</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="s1">'date'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">dshw_covid.df</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="s1">'date'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">pivot_longer</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">B_Naive</span><span class="p">,</span><span class="w"> </span><span class="n">DSHW_1</span><span class="p">,</span><span class="w"> </span><span class="n">DSHW_2</span><span class="p">),</span><span class="w"> </span><span class="n">names_to</span><span class="o">=</span><span class="s1">'Model'</span><span class="p">,</span><span class="w"> </span><span class="n">values_to</span><span class="o">=</span><span class="s1">'Active.bonds'</span><span class="p">)</span><span class="w">

</span><span class="n">timesplot</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">Active.bonds</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">Model</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">Active.Bonds</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="s1">'Actual'</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"2021-02-01"</span><span class="p">,</span><span class="s2">"2020-08-01"</span><span class="p">)),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="s2">"dashed"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_colour_viridis_d</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'bottom'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Auckland Active Bonds - Seasonal Predictions'</span><span class="p">)</span><span class="w">

</span><span class="c1"># fit and plot Bayesian Structural Time Series Model</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">bsts</span><span class="p">)</span><span class="w">

</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">training</span><span class="w">
</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">log10</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="w">

</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddLocalLinearTrend</span><span class="p">(</span><span class="nf">list</span><span class="p">(),</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddSeasonal</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">nseasons</span><span class="o">=</span><span class="m">4</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddSeasonal</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">nseasons</span><span class="o">=</span><span class="m">12</span><span class="p">)</span><span class="w">
</span><span class="n">bsts.model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bsts</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">state.specification</span><span class="o">=</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">niter</span><span class="o">=</span><span class="m">500</span><span class="p">)</span><span class="w">

</span><span class="n">burn</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">SuggestBurn</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">bsts.model</span><span class="p">)</span><span class="w">

</span><span class="n">bsts.p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict.bsts</span><span class="p">(</span><span class="n">bsts.model</span><span class="p">,</span><span class="w"> </span><span class="n">horizon</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">validation</span><span class="p">),</span><span class="w"> </span><span class="n">burn</span><span class="o">=</span><span class="n">burn</span><span class="p">,</span><span class="w"> </span><span class="n">quantiles</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span><span class="m">0.95</span><span class="p">))</span><span class="w">

</span><span class="n">d2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="o">-</span><span class="n">colMeans</span><span class="p">(</span><span class="n">bsts.model</span><span class="o">$</span><span class="n">one.step.prediction.errors</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),])</span><span class="o">+</span><span class="n">y</span><span class="p">),</span><span class="w">  
                   </span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">bsts.p</span><span class="o">$</span><span class="n">mean</span><span class="p">)),</span><span class="w"> 
                 </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">timesr</span><span class="p">),</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="n">timesr</span><span class="p">)))</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Fitted"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Actual"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Date"</span><span class="p">)</span><span class="w">

</span><span class="n">post.interval</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind.data.frame</span><span class="p">(</span><span class="w">
  </span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">bsts.p</span><span class="o">$</span><span class="n">interval</span><span class="p">[</span><span class="m">1</span><span class="p">,]),</span><span class="w">
  </span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">bsts.p</span><span class="o">$</span><span class="n">interval</span><span class="p">[</span><span class="m">2</span><span class="p">,]),</span><span class="w"> 
  </span><span class="n">subset</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="o">&gt;=</span><span class="n">as.Date</span><span class="p">(</span><span class="s1">'2020-08-01'</span><span class="p">))</span><span class="o">$</span><span class="n">Date</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">post.interval</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Lower"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Upper"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Date"</span><span class="p">)</span><span class="w">

</span><span class="c1">### Join intervals to the forecast</span><span class="w">
</span><span class="n">d3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">left_join</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="n">post.interval</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="s2">"Date"</span><span class="p">)</span><span class="w">
</span><span class="n">d3.plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">d3</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">2017</span><span class="p">)</span><span class="w">

</span><span class="c1">### Plot actual versus predicted with credible intervals for the holdout period</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d3.plot</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Date</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_ribbon</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">Lower</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="o">=</span><span class="n">Upper</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">Actual</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Actual"</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">Fitted</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Fitted"</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_colour_viridis_d</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Active.Bonds"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"date"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="n">as.Date</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"2021-02-01"</span><span class="p">,</span><span class="s2">"2020-08-01"</span><span class="p">)),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'bottom'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Auckland Active Bonds - Bayesian Structural Time Series Prediction'</span><span class="p">)</span><span class="w">
</span><span class="c1"># month over month distribution analysis</span><span class="w">
</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2018</span><span class="w">
</span><span class="n">mom.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">t.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location.Id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">Location</span><span class="p">,</span><span class="w"> </span><span class="n">date</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">MoM.Active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">diff</span><span class="p">(</span><span class="n">Active.Bonds</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="c1"># diff will cross locations, so filter cross points</span><span class="w">
    </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">Location</span><span class="p">,</span><span class="w"> </span><span class="n">MoM.Active</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">logMoM</span><span class="o">=</span><span class="n">ifelse</span><span class="p">(</span><span class="n">MoM.Active</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> 
                         </span><span class="nf">log</span><span class="p">(</span><span class="n">MoM.Active</span><span class="p">),</span><span class="w"> 
                         </span><span class="o">-</span><span class="nf">log</span><span class="p">(</span><span class="o">-</span><span class="n">MoM.Active</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">logMoM</span><span class="o">=</span><span class="n">ifelse</span><span class="p">(</span><span class="nf">is.infinite</span><span class="p">(</span><span class="n">logMoM</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">logMoM</span><span class="p">))</span><span class="w">

</span><span class="n">mom.before</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mom.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2020-08-01"</span><span class="p">))</span><span class="w">
</span><span class="n">mom.mid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mom.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2021-02-01"</span><span class="p">),</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2020-08-01"</span><span class="p">))</span><span class="w">
</span><span class="n">mom.after</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mom.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2021-02-01"</span><span class="p">))</span><span class="w">

</span><span class="n">mom.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">logMoM</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">"lm"</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">mom.before</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">"lm"</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">mom.mid</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">"lm"</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">mom.after</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_colour_viridis_d</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="n">as.Date</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"2021-02-01"</span><span class="p">,</span><span class="s2">"2020-08-01"</span><span class="p">)),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'bottom'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Auckland Active Bonds - Month over Month changes (+/- corrected log)'</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">segmented</span><span class="p">)</span><span class="w">

</span><span class="n">cp.df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r.df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">Location.Id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">2018</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">)</span><span class="w">

</span><span class="n">yy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cp.df</span><span class="o">$</span><span class="n">Active.Bonds</span><span class="w">

</span><span class="n">cp1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cp.df</span><span class="o">$</span><span class="n">date</span><span class="p">[</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">segmented</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="w"> </span><span class="n">npsi</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="o">$</span><span class="n">psi</span><span class="p">[,</span><span class="s2">"Est."</span><span class="p">]</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">cp.df</span><span class="p">))]</span><span class="w">
</span><span class="n">cp2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cp.df</span><span class="o">$</span><span class="n">date</span><span class="p">[</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">segmented</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="w"> </span><span class="n">npsi</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="o">$</span><span class="n">psi</span><span class="p">[,</span><span class="s2">"Est."</span><span class="p">]</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">cp.df</span><span class="p">))]</span><span class="w">
</span><span class="n">cp3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cp.df</span><span class="o">$</span><span class="n">date</span><span class="p">[</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">segmented</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="w"> </span><span class="n">npsi</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="o">$</span><span class="n">psi</span><span class="p">[,</span><span class="s2">"Est."</span><span class="p">]</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">cp.df</span><span class="p">))]</span><span class="w">
</span><span class="n">cp4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cp.df</span><span class="o">$</span><span class="n">date</span><span class="p">[</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">segmented</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="w"> </span><span class="n">npsi</span><span class="o">=</span><span class="m">4</span><span class="p">)</span><span class="o">$</span><span class="n">psi</span><span class="p">[,</span><span class="s2">"Est."</span><span class="p">]</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">cp.df</span><span class="p">))]</span><span class="w">
</span><span class="n">cp5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cp.df</span><span class="o">$</span><span class="n">date</span><span class="p">[</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">segmented</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="w"> </span><span class="n">npsi</span><span class="o">=</span><span class="m">5</span><span class="p">)</span><span class="o">$</span><span class="n">psi</span><span class="p">[,</span><span class="s2">"Est."</span><span class="p">]</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">cp.df</span><span class="p">))]</span><span class="w">

</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cp.df</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">Active.Bonds</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
    </span><span class="n">geom_line</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="n">as.Date</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"2021-02-01"</span><span class="p">,</span><span class="s2">"2020-08-12"</span><span class="p">)),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cp1</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cp2</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cp3</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cp4</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cp5</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">ggtitle</span><span class="p">(</span><span class="s1">'Auckland Active Bonds - Changepoint Detection'</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/data-science/'>Data Science</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/r/" class="post-tag no-text-decoration" >R</a> <a href="/tags/tidyverse/" class="post-tag no-text-decoration" >tidyverse</a> <a href="/tags/ggplot/" class="post-tag no-text-decoration" >ggplot</a> <a href="/tags/time-series/" class="post-tag no-text-decoration" >time-series</a> <a href="/tags/forecasting/" class="post-tag no-text-decoration" >forecasting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=NZ+Housing+Policy+Exploration+-+Chase+Robertson&url=https%3A%2F%2Fchaserobertson.github.io%2Fposts%2Ftenancies-amendment%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=NZ+Housing+Policy+Exploration+-+Chase+Robertson&u=https%3A%2F%2Fchaserobertson.github.io%2Fposts%2Ftenancies-amendment%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fchaserobertson.github.io%2Fposts%2Ftenancies-amendment%2F&text=NZ+Housing+Policy+Exploration+-+Chase+Robertson" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fchaserobertson.github.io%2Fposts%2Ftenancies-amendment%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/rgraphics/">Data Visualisation in base R</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/machine-learning/">machine-learning</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/r/">R</a> <a class="post-tag" href="/tags/sklearn/">sklearn</a> <a class="post-tag" href="/tags/graphics/">graphics</a> <a class="post-tag" href="/tags/visualisation/">visualisation</a> <a class="post-tag" href="/tags/beautifulsoup/">beautifulsoup</a> <a class="post-tag" href="/tags/decision-tree/">decision-tree</a> <a class="post-tag" href="/tags/forecasting/">forecasting</a> <a class="post-tag" href="/tags/ggplot/">ggplot</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/rgraphics/"><div class="card-body"> <em class="small" data-ts="1652270400" data-df="ll" > 12 May 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Data Visualisation in base R</h3><div class="text-muted small"><p> In this post, I play with various plotting and visualisation options provided by base R, with a strong focus on small details. Question 1 a) # compute x and y for full distribution x = seq(-4, 4...</p></div></div></a></div><div class="card"> <a href="/posts/taxvis/"><div class="card-body"> <em class="small" data-ts="1701946800" data-df="ll" > 8 Dec 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Progressive Income Tax Visualiser</h3><div class="text-muted small"><p> In this post, I exhibit the progressive income tax visualisation tool I’ve published as a Shiny App. Just Show the Thing Without ado, here it is: Waxing Poetic I still remember the aha-momen...</p></div></div></a></div><div class="card"> <a href="/posts/triathlon-training/"><div class="card-body"> <em class="small" data-ts="1710327600" data-df="ll" > 14 Mar 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Scraping Together a Triathlon Training Plan</h3><div class="text-muted small"><p> I signed up to compete in a half-Ironman(tm) triathlon on September 8, 2024. Completing a half-Ironman(tm) involves: 1.2 mile swim 56 mile bike 13.1 mile run It’s nice to have a solid trai...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/rgraphics/" class="btn btn-outline-primary" prompt="Older"><p>Data Visualisation in base R</p></a> <a href="/posts/svm/" class="btn btn-outline-primary" prompt="Newer"><p>Support Vector Machines</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/chase__rob">Chase Robertson</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/machine-learning/">machine-learning</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/r/">R</a> <a class="post-tag" href="/tags/sklearn/">sklearn</a> <a class="post-tag" href="/tags/graphics/">graphics</a> <a class="post-tag" href="/tags/visualisation/">visualisation</a> <a class="post-tag" href="/tags/beautifulsoup/">beautifulsoup</a> <a class="post-tag" href="/tags/decision-tree/">decision-tree</a> <a class="post-tag" href="/tags/forecasting/">forecasting</a> <a class="post-tag" href="/tags/ggplot/">ggplot</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="/assets/lib/simple-jekyll-search-1.10.0/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="/assets/lib/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script> <script src="/assets/lib/lozad-1.16.0/lozad.min.js"></script> <script src="/assets/lib/clipboard-2.0.9/clipboard.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/dayjs.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/locale/en.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/plugin/relativeTime.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="/assets/lib/bootstrap-4.6.1/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
